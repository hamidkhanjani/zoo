apiVersion: batch/v1
kind: Job
metadata:
  name: dynamodb-init
spec:
  template:
    spec:
      restartPolicy: OnFailure
      automountServiceAccountToken: false
      containers:
        - name: awscli
          image: amazon/aws-cli:2.18.18
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
              ephemeral-storage: "128Mi"
            limits:
              memory: "128Mi"
              ephemeral-storage: "256Mi"
          env:
            - name: AWS_ACCESS_KEY_ID
              value: local
            - name: AWS_SECRET_ACCESS_KEY
              value: local
            - name: AWS_DEFAULT_REGION
              value: us-west-2
            - name: DDB_ENDPOINT
              value: http://dynamodb-local:8000
          command: ["/bin/sh","-c"]
          args:
            - |
              set -e
              echo "Ensuring DynamoDB tables exist at ${DDB_ENDPOINT}"
              # Animals table with GSIs
              if aws dynamodb describe-table --table-name animals --endpoint-url "${DDB_ENDPOINT}" >/dev/null 2>&1; then
                echo "Table 'animals' already exists"
              else
                echo "Creating table 'animals'..."
                aws dynamodb create-table \
                  --table-name animals \
                  --billing-mode PAY_PER_REQUEST \
                  --attribute-definitions \
                    AttributeName=id,AttributeType=S \
                    AttributeName=title,AttributeType=S \
                    AttributeName=roomId,AttributeType=S \
                  --key-schema AttributeName=id,KeyType=HASH \
                  --global-secondary-indexes '[
                    {
                      "IndexName": "gsi_title",
                      "KeySchema": [{"AttributeName": "title", "KeyType": "HASH"}],
                      "Projection": {"ProjectionType": "ALL"}
                    },
                    {
                      "IndexName": "gsi_roomId",
                      "KeySchema": [{"AttributeName": "roomId", "KeyType": "HASH"}],
                      "Projection": {"ProjectionType": "ALL"}
                    }
                  ]' \
                  --endpoint-url "${DDB_ENDPOINT}"
                echo "Created table 'animals'"
              fi

              # Rooms table
              if aws dynamodb describe-table --table-name rooms --endpoint-url "${DDB_ENDPOINT}" >/dev/null 2>&1; then
                echo "Table 'rooms' already exists"
              else
                echo "Creating table 'rooms'..."
                aws dynamodb create-table \
                  --table-name rooms \
                  --billing-mode PAY_PER_REQUEST \
                  --attribute-definitions AttributeName=id,AttributeType=S \
                  --key-schema AttributeName=id,KeyType=HASH \
                  --endpoint-url "${DDB_ENDPOINT}"
                echo "Created table 'rooms'"
              fi

              echo "DynamoDB initialization completed"
