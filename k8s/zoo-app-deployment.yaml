apiVersion: apps/v1
kind: Deployment
metadata:
  name: zoo-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zoo-app
  template:
    metadata:
      labels:
        app: zoo-app
    spec:
      initContainers:
        - name: wait-for-dynamodb
          image: amazon/aws-cli:2.18.18
          env:
            - name: AWS_ACCESS_KEY_ID
              value: local
            - name: AWS_SECRET_ACCESS_KEY
              value: local
            - name: AWS_DEFAULT_REGION
              value: us-west-2
            - name: DDB_ENDPOINT
              value: http://dynamodb-local:8000
          command: ["/bin/sh","-c"]
          args:
            - |
              echo "Waiting for DynamoDB and required tables..."
              for i in $(seq 1 60); do
                if aws dynamodb describe-table --table-name animals --endpoint-url "$DDB_ENDPOINT" >/dev/null 2>&1 \
                   && aws dynamodb describe-table --table-name rooms --endpoint-url "$DDB_ENDPOINT" >/dev/null 2>&1; then
                  echo "DynamoDB tables are available"; exit 0;
                fi
                echo "Not ready yet ($i)..."; sleep 5;
              done
              echo "Timed out waiting for DynamoDB tables"; exit 1
      automountServiceAccountToken: false
      containers:
        - name: zoo-app
          image: your-registry/zoo-eurail:0.0.1
          ports:
            - containerPort: 8080
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: production
            - name: APP_DYNAMODB_ENDPOINT
              value: http://dynamodb-local:8000
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
              ephemeral-storage: "1Gi"
            limits:
              memory: "1Gi"
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: zoo-app
spec:
  selector:
    app: zoo-app
  ports:
    - port: 8080
      targetPort: 8080
